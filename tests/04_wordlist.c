#include <ptrie.h>
#include <sunit.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <malloc.h>

/*
 * These words derived from a random subset from
 * http://www.kilgarriff.co.uk/bnc-readme.html. I tried to filter bad
 * words, and very much appreciate the British spelling.
 *
 * There are *no* copies in this list -- all words are unique.
 */

char *words[] = {
	"decree",
	"sharply",
	"journalist",
	"diplomatic",
	"cost",
	"guardian",
	"fitness",
	"giant",
	"virus",
	"constrain",
	"pure",
	"brandy",
	"surprisingly",
	"expedition",
	"noise",
	"foundation",
	"metaphor",
	"coincidence",
	"speculation",
	"friendly",
	"dream",
	"rural",
	"lead",
	"intake",
	"suspension",
	"extract",
	"protective",
	"rack",
	"depict",
	"computer",
	"commonly",
	"lump",
	"thereby",
	"specifically",
	"batch",
	"mode",
	"street",
	"instructor",
	"working",
	"meat",
	"whom",
	"aware",
	"accomplish",
	"harm",
	"truth",
	"lecture",
	"refugee",
	"correct",
	"law",
	"pillar",
	"virtue",
	"reject",
	"forget",
	"collective",
	"duck",
	"sacrifice",
	"vein",
	"patient",
	"convince",
	"living",
	"arise",
	"product",
	"rehabilitation",
	"occasion",
	"mandatory",
	"over",
	"golf",
	"syllable",
	"stag",
	"intellectual",
	"cup",
	"disability",
	"steep",
	"deploy",
	"author",
	"thread",
	"capability",
	"of",
	"equip",
	"mould",
	"exhibit",
	"carve",
	"new",
	"administer",
	"fossil",
	"during",
	"payment",
	"belief",
	"suite",
	"goal",
	"desired",
	"beginning",
	"cease",
	"odd",
	"designer",
	"rose",
	"adaptation",
	"review",
	"rat",
	"distort",
	"question",
	"exposure",
	"light",
	"metal",
	"foreigner",
	"velvet",
	"damp",
	"somehow",
	"confuse",
	"asset",
	"marble",
	"vat",
	"concentrate",
	"advance",
	"race",
	"blonde",
	"adjacent",
	"tent",
	"teacher",
	"height",
	"meantime",
	"spoken",
	"widely",
	"employ",
	"complaint",
	"entertain",
	"admiration",
	"enthusiasm",
	"entertainment",
	"grammar",
	"invasion",
	"territorial",
	"publicity",
	"planned",
	"huge",
	"mine",
	"plenty",
	"nursing",
	"rugby",
	"abolish",
	"sir",
	"behalf",
	"along",
	"script",
	"pick",
	"federal",
	"while",
	"incidentally",
	"youth",
	"championship",
	"do",
	"gene",
	"install",
	"purchaser",
	"pupil",
	"strand",
	"bell",
	"beneficiary",
	"follow",
	"locality",
	"participate",
	"ideal",
	"aggregate",
	"usage",
	"virtual",
	"grass",
	"mixed",
	"welcome",
	"consistently",
	"disc",
	"hey",
	"row",
	"chalk",
	"enormously",
	"unexpectedly",
	"recipient",
	"realise",
	"cultivate",
	"distributor",
	"compensation",
	"assault",
	"lend",
	"pot",
	"insurance",
	"slow",
	"easy",
	"castle",
	"acceptable",
	"favourite",
	"chest",
	"tail",
	"likewise",
	"deficiency",
	"thigh",
	"producer",
	"embark",
	"gay",
	"interest",
	"participation",
	"fare",
	"likely",
	"situate",
	"frown",
	"procedure",
	"operator",
	"imply",
	"upon",
	"solo",
	"antibody",
	"preservation",
	"collar",
	"ceiling",
	"pump",
	"constituent",
	"permanent",
	"sun",
	"album",
	"bike",
	"server",
	"electrical",
	"among",
	"coming",
	"transmit",
	"nominate",
	"denounce",
	"nationalism",
	"chocolate",
	"him",
	"hemisphere",
	"confirm",
	"bowel",
	"logic",
	"software",
	"logical",
	"tense",
	"fury",
	"programme",
	"litre",
	"indirect",
	"compete",
	"beside",
	"ok",
	"bulb",
	"root",
	"menu",
	"gift",
	"trunk",
	"substantial",
	"bay",
	"variation",
	"fond",
	"grammatical",
	"outbreak",
	"influence",
	"passport",
	"regime",
	"strong",
	"fascinating",
	"jointly",
	"delicious",
	"weep",
	"face",
	"monster",
	"render",
	"definite",
	"auditor",
	"pull",
	"learning",
	"extensive",
	"civic",
	"whether",
	"chemistry",
	"location",
	"how",
	"hay",
	"protect",
	"fusion",
	"chemist",
	"screw",
	"outlet",
	"cool",
	"wheat",
	"tourism",
	"doctrine",
	"completion",
	"road",
	"lick",
	"bride",
	"focus",
	"captain",
	"user",
	"glove",
	"instruct",
	"promptly",
	"fantastic",
	"await",
	"willing",
	"bitterly",
	"breathe",
	"plausible",
	"deteriorate",
	"set",
	"threshold",
	"format",
	"marginal",
	"shelf",
	"popularity",
	"flood",
	"circular",
	"reservoir",
	"prominent",
	"symmetry",
	"video-taped",
	"worm",
	"fuss",
	"plead",
	"observe",
	"reverse",
	"studio",
	"sit",
	"dispute",
	"need",
	"pest",
	"formerly",
	"marvellous",
	"prop",
	"extreme",
	"offence",
	"villager",
	"access",
	"saint",
	"oak",
	"tightly",
	"entry",
	"whenever",
	"honestly",
	"lane",
	"bunch",
	"nest",
	"envisage",
	"venue",
	"approach",
	"contemplate",
	"inherent",
	"heating",
	"philosophical",
	"relax",
	"talented",
	"suppress",
	"port",
	"garlic",
	"stock",
	"being",
	"charity",
	"pasture",
	"directory",
	"element",
	"marker",
	"birth",
	"bottle",
	"bat",
	"homework",
	"junior",
	"modern",
	"unite",
	"reluctant",
	"calendar",
	"submit",
	"farm",
	"nomination",
	"continued",
	"large",
	"long",
	"trouser",
	"theatre",
	"form",
	"resource",
	"straw",
	"toy",
	"payable",
	"litigation",
	"comparative",
	"perception",
	"repair",
	"optical",
	"gown",
	"exchange",
	"socially",
	"lucky",
	"mainstream",
	"everyday",
	"especially",
	"puzzle",
	"finding",
	"past",
	"neat",
	"sometimes",
	"bone",
	"appendix",
	"tension",
	"timetable",
	"portrait",
	"clever",
	"notify",
	"which",
	"wrong",
	"private",
	"region",
	"forum",
	"demand",
	"sock",
	"device",
	"gear",
	"violent",
	"make-up",
	"absurd",
	"enough",
	"choice",
	"watch",
	"rotten",
	"recall",
	"darkness",
	"model",
	"praise",
	"reply",
	"procession",
	"method",
	"precious",
	"closure",
	"her",
	"smart",
	"calorie",
	"date",
	"favour",
	"false",
	"electric",
	"skipper",
	"unlawful",
	"astonishing",
	"conceal",
	"busy",
	"objective",
	"us",
	"business",
	"entitlement",
	"edition",
	"siege",
	"shrub",
	"distribute",
	"crush",
	"competitive",
	"elite",
	"suburb",
	"opera",
	"science",
	"expression",
	"operate",
	"peaceful",
	"layer",
	"noisy",
	"hatred",
	"determine",
	"kingdom",
	"seek",
	"bizarre",
	"we",
	"abortion",
	"limb",
	"temper",
	"defendant",
	"you",
	"respectable",
	"pulse",
	"supervision",
	"king",
	"reminder",
	"pair",
	"store",
	"mail",
	"inclusion",
	"legacy",
	"report",
	"demolish",
	"combination",
	"boxing",
	"implement",
	"subject",
	"trolley",
	"surrounding",
	"about",
	"relatively",
	"compatible",
	"cereal",
	"recognition",
	"jewellery",
	"onto",
	"essence",
	"replacement",
	"bush",
	"footstep",
	"defect",
	"comprise",
	"truck",
	"guest",
	"frankly",
	"dash",
	"dry",
	"valid",
	"purpose",
	"share",
	"monarch",
	"involved",
	"an",
	"newcomer",
	"headmaster",
	"relate",
	"opposite",
	"induce",
	"inevitably",
	"multiply",
	"ribbon",
	"recovery",
	"want",
	"meet",
	"damage",
	"treaty",
	"unwilling",
	"booking",
	"capital",
	"immense",
	"nursery",
	"accuse",
	"straightforward",
	"partial",
	"organise",
	"quantity",
	"grey",
	"detail",
	"tumble",
	"ball",
	"sandwich",
	"bad",
	"item",
	"ticket",
	"subsequent",
	"congratulate",
	"investigator",
	"incentive",
	"rank",
	"governor",
	"provider",
	"colleague",
	"temporary",
	"constable",
	"magical",
	"response",
	"irrespective",
	"intensify",
	"guide",
	"presidential",
	"fortune",
	"swiftly",
	"interesting",
	"oppose",
	"smoke",
	"foot",
	"anxiety",
	"opposed",
	"determined",
	"group",
	"balanced",
	"weight",
	"loyalty",
	"gently",
	"writing",
	"stick",
	"perspective",
	"dioxide",
	"failure",
	"term",
	"spoil",
	"grouping",
	"episode",
	"awareness",
	"t-shirt",
	"consider",
	"lean",
	"squadron",
	"fridge",
	"large-scale",
	"allow",
	"boat",
	"air",
	"methodology",
	"excellent",
	"steer",
	"type",
	"economist",
	"fence",
	"wedding",
	"food",
	"occupational",
	"coordinate",
	"series",
	"sculpture",
	"fun",
	"unfortunate",
	"visitor",
	"pound",
	"man",
	"remark",
	"tender",
	"line",
	"soil",
	"snake",
	"wife",
	"then",
	"he",
	"clearance",
	"reservation",
	"admit",
	"battery",
	"analysis",
	"hurry",
	"allegedly",
	"officer",
	"singer",
	"silently",
	"cow",
	"nucleus",
	"superb",
	"documentation",
	"x-ray",
	"graphics",
	"aged",
	"chamber",
	"bean",
	"pine",
	"allowance",
	"confidence",
	"expand",
	"disclose",
	"faction",
	"goalkeeper",
	"detective",
	"bite",
	"who",
	"acknowledge",
	"smooth",
	"team",
	"scatter",
	"salt",
	"also",
	"either",
	"primary",
	"bathroom",
	"skull",
	"unclear",
	"command",
	"constitution",
	"jurisdiction",
	"shall",
	"west",
	"no-one",
	"offer",
	"maximum",
	"mixture",
	"disrupt",
	"wee",
	"consistent",
	"come",
	"disturb",
	"understanding",
	"situation",
	"financially",
	"beautifully",
	"timing",
	"mouse",
	"drain",
	"relaxation",
	"pioneer",
	"executive",
	"retire",
	"sovereignty",
	"acquisition",
	"applicable",
	"exert",
	"mysterious",
	"cheer",
	"nephew",
	"journey",
	"once",
	"trouble",
	"worried",
	"funeral",
	"doctor",
	"solely",
	"preliminary",
	"guess",
	"error",
	"loss",
	"all",
	"decline",
	"bacon",
	"separate",
	"renewed",
	"compliance",
	"belly",
	"goodness",
	"clerk",
	"course",
	"park",
	"sky",
	"sheep",
	"climber",
	"number",
	"crucial",
	"bored",
	"themselves",
	"because",
	"interrupt",
	"trail",
	"crowd",
	"leave",
	"farmer",
	"sole",
	"sequence",
	"reduced",
	"statistics",
	"luxury",
	"imagine",
	"lost",
	"romance",
	"official",
	"underline",
	"safety",
	"demonstrator",
	"industry",
	"outside",
	"deter",
	"throw",
	"miner",
	"status",
	"action",
	"hole",
	"indicate",
	"reportedly",
	"unreasonable",
	"printer",
	"knife",
	"intention",
	"magic",
	"spending",
	"impulse",
	"slip",
	"embassy",
	"lifetime",
	"premise",
	"contest",
	"rotation",
	"much",
	"fiercely",
	"mosaic",
	"hen",
	"membrane",
	"correspondence",
	"alter",
	"mighty",
	"than",
	"secondary",
	"performer",
	"first",
	"qualified",
	"determination",
	"clerical",
	"wild",
	"commit",
	"locally",
	"optional",
	"between",
	"pretend",
	"breakfast",
	"predictable",
	"colonel",
	"further",
	"airline",
	"enclose",
	"multiple",
	"counselling",
	"proportional",
	"screening",
	"everywhere",
	"lounge",
	"view",
	"strictly",
	"without",
	"favourable",
	"accusation",
	"spectacular",
	"custody",
	"emission",
	"airport",
	"candidate",
	"subsequently",
	"relation",
	"making",
	"recognize",
	"wary",
	"adventure",
	"colon",
	"rocket",
	"efficient",
	"middle",
	"dissolve",
	"office",
	"revenue",
	"chin",
	"wildlife",
	"advisory",
	"wet",
	"printing",
	"dealer",
	"merely",
	"query",
	"strike",
	"bread",
	"isolated",
	"monk",
	"competent",
	"cash",
	"furnish",
	"regardless",
	"outdoor",
	"consult",
	"shareholder",
	"seed",
	"gradually",
	"exaggerate",
	"yarn",
	"effectively",
	"sister",
	"sleeve",
	"nuclear",
	"forbid",
	"movie",
	"guild",
	"enthusiast",
	"personnel",
	"resentment",
	"undertake",
	"influential",
	"linen",
	"renewal",
	"limited",
	"class",
	"negotiation",
	"result",
	"source",
	"continent",
	"black",
	"bankruptcy",
	"extra",
	"evoke",
	"title",
	"domestic",
	"regional",
	"fuel",
	"powerful",
	"priority",
	"cliff",
	"last",
	"name",
	"goat",
	"joint",
	"suspicious",
	"grim",
	"mere",
	"fluctuation",
	"perfectly",
	"considerably",
	"drift",
	"handicap",
	"daily",
	"terrace",
	"money",
	"detect",
	"calcium",
	"honour",
	"appeal",
	"heaven",
	"destiny",
	"superior",
	"transcription",
	"expense",
	"trainee",
	"fresh",
	"artificial",
	"gothic",
	"abnormal",
	"precaution",
	"confer",
	"damn",
	"redundant",
	"memorable",
	"prohibit",
	"chair",
	"liaison",
	"cautious",
	"nonsense",
	"tonight",
	"buy",
	"sale",
	"plus",
	"secondly",
	"travel",
	"choke",
	"aid",
	"administrative",
	"spelling",
	"vacuum",
	"pin",
	"ton",
	"protocol",
	"technique",
	"pride",
	"penetrate",
	"gap",
	"manual",
	"defensive",
	"emotion",
	"generally",
	"register",
	"culture",
	"electricity",
	"divide",
	"drainage",
	"left",
	"commentator",
	"haul",
	"exceptionally",
	"contribute",
	"those",
	"egg",
	"salary",
	"give",
	"deliberate",
	"amount",
	"forestry",
	"contraction",
	"impress",
	"reform",
	"nothing",
	"full-time",
	"board",
	"snatch",
	"regret",
	"lonely",
	"meanwhile",
	"reign",
	"rich",
	"exclaim",
	"texture",
	"diplomat",
	"reach",
	"comprehensive",
	"character",
	"elected",
	"symbol",
	"common",
	"advanced",
	"prompt",
	"actor",
	"essentially",
	"habitat",
	"punch",
	"incidence",
	"broken",
	"harmful",
	"oil",
	"ward",
	"transition",
	"residence",
	"march",
	"pony",
	"woodland",
	"land",
	"disadvantage",
	"wise",
	"winner",
	"alright",
	"vegetable",
	"nominal",
	"carefully",
	"possibly",
	"vector",
	"flavour",
	"completely",
	"adoption",
	"surgery",
	"barn",
	"town",
	"chimney",
	"calf",
	"hold",
	"correlation",
	"list",
	"unit",
	"purple",
	"commonwealth",
	"disposal",
	"pen",
	"moral",
	"torch",
	"conclusion",
	"famous",
	"shield",
	"wheel",
	"thereafter",
	"musician",
	"assembly",
	"annoy",
	"speech",
	NULL
};

struct test {
	char *query, *answer;
};

static struct test tests[] = {
        { .query = "sa", },
	{ .query = "ha", },
	{ .query = "jou", },
	{ .query = "lu", },
	{ .query = "e", },
	{ .query = "a", },
	{ .query = "occ", },
	{ .query = "dis", },
	{ .query = "dist", },
	{ .query = "notinthelist", },
	{ .query = NULL, },
};

/*
 * Manually solve the answers to the queries. This represents the
 * *ground truth* of the system that we'll compare the ptrie's answers
 * against.
 */
void
solve_answers(char *words[], struct test *tests)
{
	int i;

	for (i = 0; tests[i].query; i++) {
		char *soln = NULL;
		int j;

		for (j = 0; words[j]; j++) {
			/* prefix? */
			if (strncmp(words[j], tests[i].query, strlen(tests[i].query)) != 0) continue;
			if (!soln) {
				soln = words[j];
				continue;
			}
			/*
			 * If the word is lexographically less than
			 * the "current" solution, update our solution
			 * to be the new word. An imporant side-effect
			 * of `strcmp` is that a word that is a prefix
			 * of another is always "less than" the longer
			 * word, which is what we want here.
			 */
			if (strcmp(soln, words[j]) > 0) soln = words[j];
		}
		if (!soln) soln = tests[i].query;
		tests[i].answer = soln;
	}
	fflush(stdout);
}

sunit_ret_t
test_wordlist(void)
{
	struct ptrie *pt;
	int i;

	solve_answers(words, tests);

	pt = ptrie_allocate();
	SUNIT_ASSERT("ptrie allocate", pt);

	for (i = 0; words[i]; i++) {
		SUNIT_ASSERT("ptrie add", ptrie_add(pt, words[i]) != -1);
	}

	for (i = 0; tests[i].query != NULL; i++) {
		char *ret = ptrie_autocomplete(pt, tests[i].query);

		SUNIT_ASSERT("checking autocomplete", ret != NULL && strcmp(ret, tests[i].answer) == 0);

		free(ret);
	}
	ptrie_free(pt);

	return SUNIT_SUCCESS;
}

int
main(void)
{
	struct sunit_test tests[] = {
		SUNIT_TEST("wordlist", test_wordlist),
		SUNIT_TEST_TERM
	};
	sunit_execute("wordlist", tests);

	return 0;
}
